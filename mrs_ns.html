
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>남성초등학교 회의실 예약 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --accent-strong: #1d4ed8;
      --border: #d4d7e5;
      --text-main: #1f2933;
      --text-sub: #6b7280;
      --danger: #dc2626;
      --slot-free: #f9fafb;
      --slot-booked: #e0f2fe;
      --slot-booked-border: #60a5fa;
      --room-gaonnuri-bg: #fee2e2;
      --room-gaonnuri-border: #fca5a5;
      --room-gyomusil-bg: #dcfce7;
      --room-gyomusil-border: #86efac;
      --room-gyoyuk-bg: #e0f2fe;
      --room-gyoyuk-border: #60a5fa;
      --room-sangdam-bg: #fef3c7;
      --room-sangdam-border: #facc15;
      --room-oxford-bg: #f5d0fe;
      --room-oxford-border: #e879f9;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f5f7fb 45%, #fdfdfd 100%);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 32px;
    }

    header.app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    header.app-header h1 {
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.03em;
      white-space: nowrap;
      font-size: clamp(1.8rem, 3vw, 2.6rem);
      color: #0f172a;
      text-shadow: 0 2px 8px rgba(15, 23, 42, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    header.app-header h1 .logo-img {
      height: 28px;
      width: auto;
      flex-shrink: 0;
    }

    .auth-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
      backdrop-filter: blur(8px);
    }

    .user-label {
      font-size: 0.85rem;
      color: var(--text-sub);
    }

    .user-name {
      font-weight: 600;
      color: var(--accent-strong);
    }

    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s ease;
      white-space: nowrap;
      background: #fff;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }

    .btn-primary:hover {
      background: var(--accent-strong);
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-outline {
      border-color: var(--border);
      color: var(--text-main);
    }

    .btn-outline:hover {
      background: #eef2ff;
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .pill {
      border-radius: var(--radius-pill);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1.4fr);
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header small {
      font-size: 0.75rem;
      color: var(--text-sub);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    .field-label {
      font-size: 0.78rem;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-label span.required::after {
      content: " *";
      color: var(--danger);
    }

    .field-label small {
      font-size: 0.7rem;
    }

    .field-input,
    .field-select,
    .field-text {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 0.85rem;
      outline: none;
      background: #f9fafb;
      transition: all 0.12s ease;
    }

    .field-input:focus,
    .field-select:focus,
    .field-text:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      background: #ffffff;
    }

    .field-text[readonly] {
      background: #f3f4f6;
      color: #4b5563;
    }

    .inline-fields {
      display: flex;
      gap: 8px;
    }

    .inline-fields > * {
      flex: 1;
    }

    .helper-text {
      font-size: 0.72rem;
      color: var(--text-sub);
      margin-top: -2px;
      margin-bottom: 6px;
    }

    .badge {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .views-column {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .view-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .view-title {
      font-size: 0.95rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .view-title span.tag {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      border: 1px solid #c7d2fe;
    }

    .date-nav {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 2px 4px;
      background: #f3f4ff;
      border: 1px solid #c7d2fe;
    }

    .date-nav button {
      border: none;
      background: transparent;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 0.8rem;
      border-radius: 999px;
    }

    .date-nav button:hover {
      background: rgba(79, 70, 229, 0.08);
    }

    .date-display {
      padding: 0 6px;
      font-weight: 600;
      color: #111827;
    }

    .day-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      table-layout: fixed;
    }

    .day-grid thead {
      background: #eef2ff;
    }

    .day-grid th,
    .day-grid td {
      border: 1px solid #e5e7eb;
      padding: 5px 6px;
      text-align: center;
    }

    .day-grid th {
      font-weight: 600;
      color: #374151;
    }

    .day-grid td.time-cell {
      font-weight: 600;
      background: #f9fafb;
      white-space: nowrap;
    }

    .slot {
      min-height: 26px;
      border-radius: 999px;
      background: var(--slot-free);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2px 4px;
    }

    .slot.free span {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .slot.free {
      cursor: pointer;
    }

    .slot.booked {
      background: var(--slot-booked);
      border: 1px solid var(--slot-booked-border);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.15);
    }

    .slot.booked span {
      font-size: 0.7rem;
      font-weight: 600;
      color: #1d4ed8;
    }

    /* 내 예약 / 다른 사람 예약 색상 구분 */
    .slot.booked.my-reservation,
    .week-slot-item.my-reservation {
      background: #1e3a8a;
      border-color: #1f2937;
    }

    .slot.booked.my-reservation span,
    .week-slot-item.my-reservation span {
      color: #f9fafb;
    }

    .slot.booked.other-reservation,
    .week-slot-item.other-reservation {
      background: #fef3c7;
      border-color: #facc15;
    }

    .slot.booked.other-reservation span,
    .week-slot-item.other-reservation span {
      color: #92400e;
    }

    .legend-row.legend-my {
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .legend-row.legend-my .legend-item {
      font-size: 0.7rem;
    }

    .legend-dot.my-res-dot {
      background: #1e3a8a;
      border-color: #1f2937;
    }

    .legend-dot.other-res-dot {
      background: #fef3c7;
      border-color: #facc15;
    }

    .toggle-myonly {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: #4b5563;
      cursor: pointer;
    }

    .toggle-myonly input {
      display: none;
    }

    .toggle-switch {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      display: inline-flex;
      align-items: center;
      padding: 0 2px;
      box-sizing: border-box;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .toggle-handle {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.3);
      transform: translateX(0);
      transition: transform 0.15s ease;
    }

    .toggle-myonly input:checked + .toggle-switch {
      background: #4f46e5;
      border-color: #4338ca;
    }

    .toggle-myonly input:checked + .toggle-switch .toggle-handle {
      transform: translateX(12px);
    }

    /* 사용자별 고유 색상 (이메일/이름 해시 기반) */
    .user-color-0.slot.booked,
    .user-color-0.week-slot-item {
      background: #e0f2fe;
      border-color: #60a5fa;
    }
    .user-color-0.slot.booked span,
    .user-color-0.week-slot-item span {
      color: #1e3a8a;
    }

    .user-color-1.slot.booked,
    .user-color-1.week-slot-item {
      background: #dcfce7;
      border-color: #86efac;
    }
    .user-color-1.slot.booked span,
    .user-color-1.week-slot-item span {
      color: #14532d;
    }

    .user-color-2.slot.booked,
    .user-color-2.week-slot-item {
      background: #fef3c7;
      border-color: #facc15;
    }
    .user-color-2.slot.booked span,
    .user-color-2.week-slot-item span {
      color: #92400e;
    }

    .user-color-3.slot.booked,
    .user-color-3.week-slot-item {
      background: #fee2e2;
      border-color: #fecaca;
    }
    .user-color-3.slot.booked span,
    .user-color-3.week-slot-item span {
      color: #7f1d1d;
    }

    .user-color-4.slot.booked,
    .user-color-4.week-slot-item {
      background: #f5d0fe;
      border-color: #e879f9;
    }
    .user-color-4.slot.booked span,
    .user-color-4.week-slot-item span {
      color: #86198f;
    }

    .user-color-5.slot.booked,
    .user-color-5.week-slot-item {
      background: #ddd6fe;
      border-color: #a855f7;
    }
    .user-color-5.slot.booked span,
    .user-color-5.week-slot-item span {
      color: #4c1d95;
    }

    /* 개발자 전용 색상 (leens@nsworld.net) */
    .user-color-dev.slot.booked,
    .user-color-dev.week-slot-item {
      background: #0f172a;
      border-color: #1f2937;
    }
    .user-color-dev.slot.booked span,
    .user-color-dev.week-slot-item span {
      color: #e5e7eb;
    }

    .slot-booked-meta {
      display: block;
      font-size: 0.7rem;
      color: #4b5563;
    }

    .slot.disabled {
      background: #fee2e2;
      border: 1px solid #fecaca;
    }

    .slot.disabled span {
      font-size: 0.7rem;
      color: #b91c1c;
      font-weight: 500;
    }


    .slot.booked.room-gaonnuri,
    .week-slot-item.room-gaonnuri {
      background: var(--room-gaonnuri-bg);
      border-color: var(--room-gaonnuri-border);
    }

    .slot.booked.room-gyomusil,
    .week-slot-item.room-gyomusil {
      background: var(--room-gyomusil-bg);
      border-color: var(--room-gyomusil-border);
    }

    .slot.booked.room-gyoyuk,
    .week-slot-item.room-gyoyuk {
      background: var(--room-gyoyuk-bg);
      border-color: var(--room-gyoyuk-border);
    }

    .slot.booked.room-sangdam,
    .week-slot-item.room-sangdam {
      background: var(--room-sangdam-bg);
      border-color: var(--room-sangdam-border);
    }

    .slot.booked.room-oxford,
    .week-slot-item.room-oxford {
      background: var(--room-oxford-bg);
      border-color: var(--room-oxford-border);
    }

    .week-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      table-layout: fixed;
    }

    .week-grid thead {
      background: #f3f4ff;
    }

    .week-grid th,
    .week-grid td {
      border: 1px solid #e5e7eb;
      padding: 5px 6px;
      vertical-align: top;
    }

    .week-grid th {
      font-weight: 600;
      color: #374151;
      text-align: center;
      white-space: nowrap;
    }

    .week-grid td.room-cell {
      font-weight: 600;
      background: #f9fafb;
      white-space: nowrap;
      text-align: center;
    }

    .week-slot-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .week-slot-item {
      border-radius: 10px;
      padding: 3px 6px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      max-width: 100%;
      overflow: hidden;
      white-space: normal;
      text-align: center;
    }

    .week-slot-time {
      font-size: 0.7rem;
      font-weight: 600;
      color: #1d4ed8;
      text-align: center;
      width: 100%;
    }

    .week-slot-name {
      font-size: 0.7rem;
      color: #374151;
      text-align: center;
      width: 100%;
    }

    .week-slot-note {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .empty-week-cell {
      font-size: 0.7rem;
      color: #9ca3af;
      text-align: center;
      padding: 8px 0;
    }

    .legend-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 6px;
      font-size: 0.7rem;
      color: #6b7280;
    }

    .legend-row.legend-combined {
      justify-content: space-between;
      align-items: center;
    }

    .legend-group-left,
    .legend-group-right {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .legend-dot.booked {
      background: var(--slot-booked);
      border-color: var(--slot-booked-border);
    }

    .legend-dot.disabled {
      background: #fee2e2;
      border-color: #fecaca;
    }

    .alert {
      font-size: 0.75rem;
      border-radius: 10px;
      padding: 6px 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .alert-info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .alert-error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .alert-icon {
      font-size: 0.9rem;
      line-height: 1;
      margin-top: 1px;
    }

    .alert-text {
      flex: 1;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 900px) {
      .layout-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 640px) {
      header.app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      header.app-header h1 {
        font-size: 1.8rem;
      }

      .auth-box {
        align-self: stretch;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <h1><img src="https://nisb.kr/plugins/custom_plugin/src/Components/Themes/CustomTheme/assets/images/ft_logo_1.png" alt="남성초 로고" class="logo-img" />남성초등학교 회의실 예약 시스템</h1>
      <div class="auth-box">
        <div>
          <div class="user-label">
            <span id="auth-status">로그인 필요</span>
          </div>
          <div class="user-name" id="auth-user-name">@nsworld.net 계정으로 로그인하세요</div>
        </div>
        <div>
          <button id="login-btn" class="btn btn-primary">구글 로그인</button>
          <button id="logout-btn" class="btn btn-outline hidden">로그아웃</button>
        </div>
      </div>
    </header>

    <main class="layout-main">
      <!-- 예약 폼 -->
      <section class="card">
        <div class="card-header">
          <h2>예약 만들기</h2>
          <span class="badge">@nsworld.net 전용</span>
        </div>

        <div id="auth-alert" class="alert alert-info">
          <div class="alert-icon">ℹ️</div>
          <div class="alert-text">
            회의실 예약을 하려면 먼저 <strong>@nsworld.net</strong> 구글 계정으로 로그인해야 합니다.
          </div>
        </div>

        <form id="reservation-form">
          <div class="field-group">
            <label class="field-label">
              <span class="required">예약 날짜</span>
            </label>
            <input type="date" id="date-input" class="field-input" required />
          </div>

          <div class="inline-fields">
            <div class="field-group">
              <label class="field-label">
                <span class="required">회의실</span>
              </label>
              <select id="room-select" class="field-select" required>
                <option value="">선택하세요</option>
                <option value="가온누리">가온누리</option>
                <option value="교무실">교무실</option>
                <option value="교육문화관">교육문화관</option>
                <option value="상담실">상담실</option>
                <option value="옥스퍼드 교실">옥스퍼드 교실</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label">
                <span class="required">시간</span>
              </label>
              <select id="time-select" class="field-select" required>
                <option value="">선택하세요</option>
              </select>
            </div>
          </div>

          <div class="field-group">
            <label class="field-label">
              <span>반복 예약</span>
            </label>
            <div class="inline-fields">
              <select id="repeat-select" class="field-select">
                <option value="none">반복 없음</option>
                <option value="weekly">매주 같은 요일 반복</option>
              </select>
              <input type="date" id="repeat-until" class="field-input" />
            </div>
            <div class="helper-text">
              반복 예약을 설정하는 경우, <strong>종료일</strong>까지 같은 요일・시간・공간으로 예약됩니다.
            </div>
          </div>

          <div class="field-group">
            <label class="field-label">
              <span>예약자 이름</span>
              <small>로그인한 계정 이름으로 자동 연동</small>
            </label>
            <input type="text" id="reserver-name" class="field-text" readonly placeholder="로그인 후 자동 입력됩니다." />
          </div>

          <div class="field-group">
            <label class="field-label">
              <span>비고(선택)</span>
            </label>
            <input type="text" id="note-input" class="field-input" placeholder="간단한 용도, 모임 이름 등을 적어주세요." />
          </div>

          <div id="form-error" class="alert alert-error hidden">
            <div class="alert-icon">⚠️</div>
            <div class="alert-text" id="form-error-text"></div>
          </div>

          <button type="submit" class="btn btn-primary" style="width:100%; margin-top:4px;">
            예약 등록
          </button>
        </form>

        <p class="helper-text" style="margin-top:10px;">
          ※ 같은 날짜・시간・회의실에 이미 예약이 있는 경우, <strong>중복 예약이 자동으로 차단</strong>됩니다.
        </p>
      </section>

      <!-- 보기 영역: 위쪽 일간 예약 현황 / 아래쪽 주간 예약 현황 -->
      <section class="views-column">
        <!-- 일간 예약 현황 -->
        <section class="card">
          <div class="view-title-row">
            <div class="view-title">
              <span>일간 예약 현황</span>
              <span class="tag">선택한 날짜 기준</span>
            </div>
            <div class="date-nav">
              <button type="button" id="prev-day">◀</button>
              <span class="date-display" id="day-display"></span>
              <button type="button" id="next-day">▶</button>
            </div>
          </div>

          <table class="day-grid" id="day-grid">
            <thead>
              <tr>
                <th>시간</th>
                <th>가온누리</th>
                <th>교무실</th>
                <th>교육문화관</th>
                <th>상담실</th>
                <th>옥스퍼드 교실</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS로 채움 -->
            </tbody>
          </table>

          <div class="legend-row legend-combined">
            <div class="legend-group-left">
              <div class="legend-item">
                <span class="legend-dot my-res-dot"></span> <span>내 예약</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot other-res-dot"></span> <span>다른 사람 예약</span>
              </div>
            </div>
            <div class="legend-group-right">
              <div class="legend-item">
                <span class="legend-dot"></span> <span>예약 가능</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot booked"></span> <span>예약됨</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot disabled"></span> <span>예약 불가</span>
              </div>
            </div>
          </div>
        </section>

        <!-- 주간 예약 현황 -->
        <section class="card">
          <div class="view-title-row">
            <div class="view-title">
              <span>주간 예약 현황</span>
              <span class="tag">월요일 ~ 금요일</span>
            </div>
            <div class="date-nav">
              <button type="button" id="prev-week">◀</button>
              <span class="date-display" id="week-display"></span>
              <button type="button" id="next-week">▶</button>
            </div>
          </div>

          <table class="week-grid" id="week-grid">
            <thead>
              <tr>
                <th>회의실</th>
                <th>월</th>
                <th>화</th>
                <th>수</th>
                <th>목</th>
                <th>금</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS로 채움 -->
            </tbody>
          </table>

          <div class="legend-row legend-my">
            <div class="legend-item">
              <span class="legend-dot my-res-dot"></span> <span>내 예약</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot other-res-dot"></span> <span>다른 사람 예약</span>
            </div>
            <label class="toggle-myonly">
              <span>내 예약만 보기</span>
              <input type="checkbox" id="my-only-toggle" />
              <span class="toggle-switch">
                <span class="toggle-handle"></span>
              </span>
            </label>
          </div>
        </section>
      </section>
    </main>
  </div>

  
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase 설정
  const firebaseConfig = {
    apiKey: "AIzaSyAvlHnsZJ1kFBw7LXTtwlheShJk96yH960",
    authDomain: "namsung-meeting-room-7811f.firebaseapp.com",
    projectId: "namsung-meeting-room-7811f",
    storageBucket: "namsung-meeting-room-7811f.firebasestorage.app",
    messagingSenderId: "863278514186",
    appId: "1:863278514186:web:827dfd1ffc8947918e1ff3"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<script>
  // ---- 상수 정의 ----
  const ROOMS = ["가온누리", "교무실", "교육문화관", "상담실", "옥스퍼드 교실"];

  const USER_COLOR_CLASSES = [
    "user-color-0",
    "user-color-1",
    "user-color-2",
    "user-color-3",
    "user-color-4",
    "user-color-5"
  ];

  function getUserColorClassFromKey(key) {
    if (!key) return USER_COLOR_CLASSES[0];
    // 개발자 전용 색상 우선 적용
    if (key === "leens@nsworld.net") {
      return "user-color-dev";
    }
    let hash = 0;
    for (let i = 0; i < key.length; i++) {
      hash = (hash * 31 + key.charCodeAt(i)) >>> 0;
    }
    const idx = hash % USER_COLOR_CLASSES.length;
    return USER_COLOR_CLASSES[idx];
  }

  function isMyReservation(reservation) {
    if (!currentUser || !reservation) return false;
    const myEmail = currentUser.email || "";
    const resEmail = reservation.email || "";
    if (myEmail && resEmail && myEmail === resEmail) return true;
    const myName = currentUser.name || "";
    if (!resEmail && myName && reservation.name && myName === reservation.name) return true;
    return false;
  }

  function getReservationColorClass(reservation) {
    return isMyReservation(reservation) ? "my-reservation" : "other-reservation";
  }


  const ROOM_CLASS_MAP = {
    "가온누리": "room-gaonnuri",
    "교무실": "room-gyomusil",
    "교육문화관": "room-gyoyuk",
    "상담실": "room-sangdam",
    "옥스퍼드 교실": "room-oxford"
  };


  const TIME_SLOTS = [
    "08:30~08:55",
    "09:00~09:40",
    "09:45~10:25",
    "10:30~11:10",
    "11:15~11:55",
    "12:00~12:40",
    "12:40~13:25",
    "13:30~14:10",
    "14:15~14:55",
    "15:00~15:40",
    "15:40~16:30"
  ];

  // Firestore 연동용 예약 캐시
  let reservations = []; // {id, date(YYYY-MM-DD), room, timeSlotIndex, name, note}

  let currentUser = null; // {name, email}
  let selectedDate = new Date();
  let weekBaseDate = new Date();
  let showOnlyMine = false;

  // ---- 유틸 함수 ----
  function formatDateKey(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function parseDateFromInput(value) {
    if (!value) return null;
    const [y, m, d] = value.split("-").map(Number);
    return new Date(y, m - 1, d);
  }

  function formatKoreanDate(date) {
    const dayNames = ["일", "월", "화", "수", "목", "금", "토"];
    const y = date.getFullYear();
    const m = date.getMonth() + 1;
    const d = date.getDate();
    const w = dayNames[date.getDay()];
    return `${y}. ${m}. ${d}. (${w})`;
  }

  function getWeekRange(date) {
    const base = new Date(date);
    const day = base.getDay(); // 0(일)~6(토)
    const diffToMonday = (day + 6) % 7;
    const monday = new Date(base);
    monday.setDate(base.getDate() - diffToMonday);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);
    return { monday, sunday };
  }

  function hasConflict(dateKey, room, timeSlotIndex) {
    return reservations.some(
      (r) => r.date === dateKey && r.room === room && r.timeSlotIndex === timeSlotIndex
    );
  }

  function isWeekday(date) {
    const day = date.getDay(); // 0:일 ~ 6:토
    return day >= 1 && day <= 5; // 월~금만 허용
  }

  async function handleQuickReserve(room, timeIndex) {
    clearError();

    if (!currentUser) {
      showError("@nsworld.net 계정으로 먼저 로그인해 주세요.");
      return;
    }

    const date = new Date(selectedDate);
    const dateKey = formatDateKey(date);
    const existing = reservations.find(
      (r) => r.date === dateKey && r.room === room && r.timeSlotIndex === timeIndex
    );

    const currentName = currentUser.name || currentUser.email;

    // 이미 예약된 상태라면: 본인 예약만 취소 가능
    if (existing) {
      if (existing.name !== currentName) {
        showError("다른 사용자의 예약은 취소할 수 없습니다.");
        return;
      }
      await deleteReservation(existing.id);
      await fetchReservations();
      return;
    }

    // 비어 있는 상태라면: 새로 예약 (월~금만)
    if (!isWeekday(date)) {
      showError("예약은 월요일부터 금요일까지만 가능합니다.");
      return;
    }

    if (await addReservation(dateKey, room, timeIndex, currentName, "", currentUser.email || "")) {
      await fetchReservations();
    } else {
      showError("선택한 시간에는 이미 예약이 존재합니다.");
    }
  }


  async function handleWeekItemClick(reservation) {
    clearError();

    if (!currentUser) {
      showError("@nsworld.net 계정으로 먼저 로그인해 주세요.");
      return;
    }

    const currentName = currentUser.name || currentUser.email;

    if (reservation.name !== currentName) {
      showError("다른 사용자의 예약은 취소할 수 없습니다.");
      return;
    }

    await deleteReservation(reservation.id);
    await fetchReservations();
  }

  // ---- Firestore 연동 ----
  async function fetchReservations() {
    const snapshot = await db.collection("reservations").get();
    reservations = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    renderDayView();
    renderWeekView();
  }

  async function addReservation(dateKey, room, timeSlotIndex, name, note, email) {
    if (hasConflict(dateKey, room, timeSlotIndex)) {
      return false;
    }

    const docRef = await db.collection("reservations").add({
      date: dateKey,
      room,
      timeSlotIndex,
      name,
      note: note || "",
      email: email || ""
    });

    reservations.push({
      id: docRef.id,
      date: dateKey,
      room,
      timeSlotIndex,
      name,
      note: note || "",
      email: email || ""
    });

    return true;
  }

  async function deleteReservation(id) {
    await db.collection("reservations").doc(id).delete();
    reservations = reservations.filter((r) => r.id !== id);
  }

  // ---- UI 렌더링 ----
  function renderDayView() {
    const tbody = document.querySelector("#day-grid tbody");
    tbody.innerHTML = "";
    const dateKey = formatDateKey(selectedDate);
    const weekend = !isWeekday(selectedDate);

    TIME_SLOTS.forEach((slot, index) => {
      const tr = document.createElement("tr");

      const timeTd = document.createElement("td");
      timeTd.className = "time-cell";
      timeTd.textContent = slot;
      tr.appendChild(timeTd);

      ROOMS.forEach((room) => {
        const td = document.createElement("td");
        const slotDiv = document.createElement("div");

        if (weekend) {
          // 토/일: 항상 예약 불가
          slotDiv.className = "slot disabled";
          const main = document.createElement("span");
          main.textContent = "예약 불가";
          slotDiv.appendChild(main);
        } else {
          const existing = reservations.find(
            (r) => r.date === dateKey && r.room === room && r.timeSlotIndex === index
          );

          if (existing) {
            const colorClass = getReservationColorClass(existing);
            slotDiv.className = "slot booked " + colorClass;
            const main = document.createElement("span");
            main.textContent = existing.name; // 예약자명만 표시
            slotDiv.appendChild(main);
            slotDiv.addEventListener("click", () => {
              handleQuickReserve(room, index);
            });
          } else {
            slotDiv.className = "slot free";
            const main = document.createElement("span");
            main.textContent = "예약 가능";
            slotDiv.appendChild(main);
            // 빠른 예약: 빈 슬롯 클릭 시 즉시 예약/취소 토글
            slotDiv.addEventListener("click", () => {
              handleQuickReserve(room, index);
            });
          }
        }

        td.appendChild(slotDiv);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    document.getElementById("day-display").textContent = formatKoreanDate(selectedDate);
  }

  function renderWeekView() {
    const tbody = document.querySelector("#week-grid tbody");
    tbody.innerHTML = "";

    const { monday, sunday } = getWeekRange(weekBaseDate);

    document.getElementById("week-display").textContent =
      `${monday.getFullYear()}. ${monday.getMonth() + 1}. ${monday.getDate()} ~ ` +
      `${sunday.getFullYear()}. ${sunday.getMonth() + 1}. ${sunday.getDate()}`;

    ROOMS.forEach((room) => {
      const tr = document.createElement("tr");

      const roomTd = document.createElement("td");
      roomTd.className = "room-cell";
      roomTd.textContent = room;
      tr.appendChild(roomTd);

      for (let i = 0; i < 5; i++) {
        const dayDate = new Date(monday);
        dayDate.setDate(monday.getDate() + i);
        const dateKey = formatDateKey(dayDate);

        const td = document.createElement("td");

        const roomReservations = reservations
          .filter((r) => r.date === dateKey && r.room === room)
          .sort((a, b) => a.timeSlotIndex - b.timeSlotIndex);

        const visibleReservations = showOnlyMine
          ? roomReservations.filter((r) => isMyReservation(r))
          : roomReservations;

        if (visibleReservations.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty-week-cell";
          empty.textContent = "-";
          td.appendChild(empty);
        } else {
          const list = document.createElement("div");
          list.className = "week-slot-list";

          visibleReservations.forEach((r) => {
            const item = document.createElement("div");
            const colorClass = getReservationColorClass(r);
            item.className = "week-slot-item " + colorClass;

            const timeSpan = document.createElement("span");
            timeSpan.className = "week-slot-time";
            timeSpan.textContent = TIME_SLOTS[r.timeSlotIndex];

            const nameSpan = document.createElement("span");
            nameSpan.className = "week-slot-name";
            nameSpan.textContent = r.name; // 예약자명만 표시

            item.appendChild(timeSpan);
            item.appendChild(nameSpan);

            // 주간 보기에서도 클릭 시 예약 취소 가능 (본인 예약만)
            item.addEventListener("click", () => {
              handleWeekItemClick(r);
            });

            list.appendChild(item);
          });

          td.appendChild(list);
        }

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });
  }

  function syncDateInputs() {
    const dateInput = document.getElementById("date-input");
    dateInput.value = formatDateKey(selectedDate);
  }

  function showError(message) {
    const box = document.getElementById("form-error");
    const textEl = document.getElementById("form-error-text");
    textEl.textContent = message;
    box.classList.remove("hidden");
  }

  function clearError() {
    const box = document.getElementById("form-error");
    box.classList.add("hidden");
  }

  function updateAuthUI() {
    const status = document.getElementById("auth-status");
    const name = document.getElementById("auth-user-name");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const reserverName = document.getElementById("reserver-name");
    const authAlert = document.getElementById("auth-alert");

    if (currentUser) {
      status.textContent = "로그인됨";
      name.textContent = currentUser.email;
      reserverName.value = currentUser.name || currentUser.email;
      authAlert.classList.add("hidden");
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
    } else {
      status.textContent = "로그인 필요";
      name.textContent = "@nsworld.net 계정으로 로그인하세요";
      reserverName.value = "";
      authAlert.classList.remove("hidden");
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
    }
  }

  // ---- Google 로그인 ----
  function googleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();

    auth.signInWithPopup(provider)
      .then((result) => {
        const user = result.user;
        const email = user.email || "";
        const name = user.displayName || email.split("@")[0];

        if (!email.endsWith("@nsworld.net")) {
          alert("@nsworld.net 도메인 계정만 사용할 수 있습니다.");
          return auth.signOut();
        }

        currentUser = { name, email };
        updateAuthUI();
      })
      .catch((error) => {
        console.error(error);
        alert("로그인 중 오류가 발생했습니다.");
      });
  }

  function googleLogout() {
    auth.signOut().then(() => {
      currentUser = null;
      updateAuthUI();
    });
  }

  // ---- 초기화 ----
  function initTimeOptions() {
    const select = document.getElementById("time-select");
    TIME_SLOTS.forEach((slot, index) => {
      const opt = document.createElement("option");
      opt.value = String(index);
      opt.textContent = slot;
      select.appendChild(opt);
    });
  }

  function initDateDefaults() {
    const dateInput = document.getElementById("date-input");
    const todayKey = formatDateKey(selectedDate);
    dateInput.value = todayKey;
    weekBaseDate = new Date(selectedDate);
  }

  function attachEventHandlers() {
    document.getElementById("login-btn").addEventListener("click", googleLogin);
    document.getElementById("logout-btn").addEventListener("click", googleLogout);

    const myOnlyToggle = document.getElementById("my-only-toggle");
    if (myOnlyToggle) {
      myOnlyToggle.addEventListener("change", (e) => {
        showOnlyMine = e.target.checked;
        renderWeekView();
      });
    }

    document.getElementById("date-input").addEventListener("change", (e) => {
      const d = parseDateFromInput(e.target.value);
      if (d) {
        selectedDate = d;
        weekBaseDate = new Date(d);
        renderDayView();
        renderWeekView();
      }
    });

    document.getElementById("prev-day").addEventListener("click", () => {
      selectedDate.setDate(selectedDate.getDate() - 1);
      weekBaseDate = new Date(selectedDate);
      syncDateInputs();
      renderDayView();
      renderWeekView();
    });

    document.getElementById("next-day").addEventListener("click", () => {
      selectedDate.setDate(selectedDate.getDate() + 1);
      weekBaseDate = new Date(selectedDate);
      syncDateInputs();
      renderDayView();
      renderWeekView();
    });

    document.getElementById("prev-week").addEventListener("click", () => {
      weekBaseDate.setDate(weekBaseDate.getDate() - 7);
      renderWeekView();
    });

    document.getElementById("next-week").addEventListener("click", () => {
      weekBaseDate.setDate(weekBaseDate.getDate() + 7);
      renderWeekView();
    });

    document.getElementById("reservation-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearError();

      if (!currentUser) {
        showError("@nsworld.net 계정으로 먼저 로그인해 주세요.");
        return;
      }

      const dateVal = document.getElementById("date-input").value;
      const roomVal = document.getElementById("room-select").value;
      const timeVal = document.getElementById("time-select").value;
      const repeatVal = document.getElementById("repeat-select").value;
      const repeatUntilVal = document.getElementById("repeat-until").value;
      const noteVal = document.getElementById("note-input").value.trim();
      const nameVal = document.getElementById("reserver-name").value.trim() || currentUser.name;

      if (!dateVal || !roomVal || timeVal === "") {
        showError("예약 날짜, 회의실, 시간을 모두 선택해 주세요.");
        return;
      }

      const baseDate = parseDateFromInput(dateVal);
      if (!baseDate) {
        showError("잘못된 날짜 형식입니다.");
        return;
      }

      if (!isWeekday(baseDate)) {
        showError("예약은 월요일부터 금요일까지만 가능합니다.");
        return;
      }

      const baseDateKey = formatDateKey(baseDate);
      const timeIndex = parseInt(timeVal, 10);

      let successCount = 0;
      let conflictCount = 0;

      if (repeatVal === "none") {
        if (await addReservation(baseDateKey, roomVal, timeIndex, nameVal, noteVal, currentUser.email || "")) {
          successCount++;
        } else {
          conflictCount++;
        }
      } else if (repeatVal === "weekly") {
        const untilDate = parseDateFromInput(repeatUntilVal);
        if (!untilDate) {
          showError("반복 예약의 종료일을 선택해 주세요.");
          return;
        }
        if (untilDate < baseDate) {
          showError("반복 종료일은 시작일 이후여야 합니다.");
          return;
        }

        const tempDate = new Date(baseDate);
        while (tempDate <= untilDate) {
          const key = formatDateKey(tempDate);
          if (await addReservation(key, roomVal, timeIndex, nameVal, noteVal, currentUser.email || "")) {
            successCount++;
          } else {
            conflictCount++;
          }
          tempDate.setDate(tempDate.getDate() + 7);
        }
      }

      if (conflictCount > 0 && successCount === 0) {
        showError("선택한 조건으로 이미 예약이 존재하여 등록할 수 없습니다.");
      } else if (conflictCount > 0) {
        showError(`일부 날짜는 이미 예약이 있어 제외되었으며, ${successCount}건의 예약이 등록되었습니다.`);
      }

      await fetchReservations(); // 최신 상태 다시 반영
    });
  }

  // ---- 인증 상태 변화 감지 ----
  auth.onAuthStateChanged((user) => {
    if (user) {
      const email = user.email || "";
      const name = user.displayName || email.split("@")[0];

      if (!email.endsWith("@nsworld.net")) {
        alert("@nsworld.net 도메인 계정만 사용할 수 있습니다.");
        auth.signOut();
        return;
      }

      currentUser = { name, email };
    } else {
      currentUser = null;
    }
    updateAuthUI();
  });

  // ---- 시작 ----
  document.addEventListener("DOMContentLoaded", async () => {
    initTimeOptions();
    initDateDefaults();
    updateAuthUI();
    attachEventHandlers();
    await fetchReservations();
  });
</script>
</body>
</html>
